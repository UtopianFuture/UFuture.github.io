## 系统虚拟化——原理与实现

在[蔚来](https://www.nio.cn/)面试的时候，前两面和面试官聊的都很好，因为做的项目确实有点东西，对内核也有一定了解，所以这两面都没有写题。但是在三面的时候应该是部门的大 leader，之前做了 20 多年的虚拟化，而且他做过和我类似的工作，所以我这点微末道行在他面前根本不够看，种种不足表露无疑。最重要的是对虚拟化没有一个全面、准确的认识，比如他问我什么是虚拟化，我的回答是“虚拟化其实就是为你需要虚拟的设备创建一个数据结构，然后构造一系列的函数来维护这个数据结构”。其实从 QEMU 来看这种理解是没有问题的，但是 QEMU 只是系统虚拟化的一种实现，而虚拟化是一个非常大的、很早就提出来的概念，所以他说我对虚拟化的理解还是片面的没有问题。他给我的建议是加强对虚拟化基础知识的准确把握，我认为他的建议非常有道理，所以再看一看《系统虚拟化——原理与实现》才而纠正之前以项目为驱动导致的对基础概念理解不到位的问题，同时也算是为之后写论文打个基础吧。

 当然，这本书其实年头有些久，之后还会结合《Hardware and Software Support for Virtualization》做些补充。

### 虚拟化概述

虚拟化技术根本的思想就是“中间层”和“模块化”。

> Virtualization is the application of the layering principle through enforced modularity, whereby the exposed virtual resource is identical to the underlying physical resource being virtualized.

#### 可虚拟化架构与不可虚拟化架构

在没有虚拟化的环境中，是由操作系统管理物理硬件的，但是在虚拟环境中，VMM 抢占了操作系统的位置，变成真实物理硬件的管理者，同时向上层的软件呈现虚拟的硬件平台。

虚拟机可以看作是物理机资源的一种高效隔离的复制，其中需要完成三个任务：同质、高效和资源受控。如果一个 VMM 没有实现这个三个任务，那么可以说这个虚拟机是失败的。

首先介绍两个重要的概念：特权指令和敏感指令。

特权指令：系统中操作和管理关键系统资源的指令，这些指令**只有在最高特权级上能够正确运行**。如果在非特权级上运行，特权指令会引发一个异常，处理器会陷入到最高特权级，交由系统软件处理。

敏感指令：操作特权资源的指令，包括修改虚拟机的运行模式或者下面物理机的状态；读写敏感的寄存器或内存，如时钟或中断寄存器；访问存储保护系统、内存系统或者地址重定位系统以及所有的 I/O 指令。

显然，所有的特权指令都是敏感指令，但不是所有的敏感指令都是特权指令。VMM 为了控制所有的系统资源，不允许直接 guestos 直接执行敏感指令。如果一个架构所有的敏感指令都是特权指令，那么很好办：将 VMM 运行在系统的最高特权级上，而将 guestos 运行在非最高特权级上，当 guestos 因执行敏感指令而陷入到 VMM 时，VMM 模拟执行引起异常的敏感指令，这种方法称为“陷入再模拟”。

故判断一个架构是不是可虚拟化架构，就在于其对敏感指令的支持。如果该架构无法支持在所有的敏感指令上触发异常，那么我们称该架构有“虚拟化漏洞”。当然有一些方法能够填补“虚拟化漏洞”，最简单粗暴的就是对所有指令都模拟，“二进制翻译”就是这样一种技术，所以说在没有硬件辅助的虚拟化出现之前，“二进制翻译”就是虚拟化技术的一种实现，直到现在，“二进制翻译”也是异构虚拟化的解决方案。

#### 处理器虚拟化

#### 内存虚拟化

这两部分可以以 QEMU + KVM 为例理解，思想都是一样的。

#### I/O 虚拟化

#### VMM相关

根据 VMM 提供的虚拟平台类型可以将 VMM 分成两类：

- 完全虚拟化，无需对操作系统进行任何修改，guestos 觉察不到是运行在一个虚拟平台上（但是可以通过一些技术手段来检查是否运行在虚拟机上）。其经历了软件辅助的完全虚拟化和硬件辅助的完全虚拟化两个阶段。
- 类虚拟化，需要对 guestos 进行一些修改以适应虚拟环境。

### 基于软件的完全虚拟化

#### 概述

#### CPU 虚拟化

#### 内存虚拟化

#### I/O 虚拟化

### 硬件辅助虚拟化

#### 概述

#### CPU 虚拟化的硬件支持

#### 中断虚拟化

#### 内存虚拟化

#### I/O 虚拟化的硬件支持

### 类虚拟化技术

#### 概述

#### 类虚拟化体系结构

### 前沿虚拟化技术

#### 基于容器的虚拟化技术

#### 系统安全

#### 系统标准化

#### 智能设备

##### 多队列网卡

##### SR-IOV
