## File System

### 虚拟文件系统

虚拟文件系统（Virtual Filesystem Switch）所隐含的思想是把表示很多不同种类文件系统的共同信息放入内核，其中有一个字段或函数来支持内核所支持的所有实际文件系统所提供的任何操作。对所调用的每个读、写或者其他函数，内核都能将其替换成本地文件系统的实际函数。

VFS 支持的文件系统可以分成三种主要类型：

- 磁盘文件系统。这些文件系统（Ext2, Ext3, System V, UFS, NTFS 等）管理在本地磁盘分区中可用的存储空间或其他可以起到磁盘作用的设备（如 USB 闪存）
- 网络文件系统。这些文件系统允许轻易的访问属于其他网络计算机的文件系统所包含的文件。如：NFS, AFS, CIFS 等。
- 特殊文件系统。这些文件系统不管理本地或者远程磁盘空间。/proc 是一个典型的特殊文件系统。

#### 通用文件模型

VFS 为了支持尽可能多的文件系统，引入了一个通用的文件模型，要实现每个具体的文件系统，必须将其物理组织结构转换为虚拟文件系统的通用文件模型。

应用程序对 `read()` 的调用引起内核调用相应的 `sys_read()` 系统调用，而文件再内核中是用 `struct file` 表示的，`file` 中包含成员变量 `f_op`，该成员变量包含指向实际文件系统的函数指针，包括读写文件的函数，`sys_read()` 找到该函数的指针，并调用它。

通用文件模型由下列对象类型组成：

- 超级块对象（superblock object）

  存放以安装文件系统的有关信息。基于磁盘的文件系统，这类对象通常对应于存放在磁盘上的文件系统控制块（filesystem control block）。

- 索引节点对象（inode object）

  存放 具体文件的信息，每个索引节点都有一个索引节点号，这个节点号唯一地表示文件系统中的文件。

- 文件对象（file object）

  存放打开文件域进程之间进行交互的有关信息，这类信息仅当进程访问文件期间存在内核内存中。

- 目录项对象（dentry object）

  存放目录项（文件的特定名称）域对应文件进行链接的有关信息。

下面我们看看进程怎样与文件进行交互。三个不同的进程已经打开同一个文件，其中两个进程使用同一个硬链接，这样每个进程都有自己的文件对象，但只需要两个目录项对象，每个硬链接对应一个目录项，这两个目录项指向同一个索引节点，该索引节点表示超级块以及随后的普通磁盘文件。

![process-VFS.png](https://github.com/UtopianFuture/UtopianFuture.github.io/blob/master/image/process-VFS.png?raw=true)

### VFS 的数据结构

### 文件系统类型

### 文件系统处理

### 路径名查找

### VFS 系统调用的实现

文件系统中有几个重要的数据结构（这应该是存储在硬盘中的实际文件系统的数据结构）：

- **superblock**: 记录此 fs 的整体信息，包括 inode/block 的总量、使用量、剩余量，以及文件系统的格式与相关信息等；
- **inode table**: superblock 之后就是 inode table，存储了全部 inode；
- **data block**: inode table 之后就是 data block。文件的内容保存在这个区域，磁盘上所有块的大小都一样；
- **inode**: 记录文件的属性，同时记录此文件的数据所在的 block 号码。每个 inode 对应一个文件/目录的结构，这个结构它包含了一个文件的长度、创建及修改时间、权限、所属关系、磁盘中的位置等信息。
- **block**: 实际记录文件的内容。一个较大的文件很容易分布上千个独产的磁盘块中，而且，一般都不连续，太散会导致读写性能急剧下降。
