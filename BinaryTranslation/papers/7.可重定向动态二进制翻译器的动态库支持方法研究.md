## 可重定向动态二进制翻译器的动态库支持方法研究

### 1. 动态库支持框架

为动态二进制翻译平台提供动态库支持，一方面可以用来运行由源机器平台**动态编译**出来的可执行程序；另一方面也有利于发现动态二进制翻译平台中本身的潜在错误。

#### 1.1. 系统构架

在动态二进制翻译系统下，如果需要支持动态链接的可执行程序，那么就必须首先完成动态链接器的工作。动态库支持框架可以分为动态库加载，数据和函数重定位和过程调用环境模拟三个部分。

![img](https://github.com/UtopianFuture/UtopianFuture.github.io/blob/master/image/7.1.png?raw=true)  


- 翻译器将源机器平台的二进制映像加载到内存中。
- 加载完后读取.dynamic 节的信息，提取出动态链接的有关信息，包括含有源机器平台可执行程序的库依赖信息的 NEEDED 表项、全局偏移表的首地址、过程链接表的首地址、字符串表的首地址、符号表的首地址、重定位表的首地址和大小。
- 根据.dynamic 节提供的 NEEDED 表项信息，开始加载程序依赖的动态库。
- 对照重定位表，找到需要重定位的符号信息，并利用 dlfcn.h 系统头文件提供的 dlsym 函数来查询该符号的地址，并将符号的实际地址更新到该符号位于全局偏移表的具体偏移处。
- 在处理好数据和函数的重定位后，就进入动态二进制翻译的主执行流程。

主执行流程如下：

(1) 以下一条执行指令的源机器地址(SPC)为输入，判断该地址**是否为本地库函数的入口地址**。如果是，则跳至(2)，否，跳至(4)。

(2) 如果是本地库函数的入口地址，就模拟出实际后端的过程调用环境，包括参数的传递，栈帧的具体内容。

(3) 模拟出过程调用环境后，调用本地库函数的入口地址，并将返回值保存至前端 CPU 状态。

(4) 查找哈希表，判断目标缓存中是否有与该地址对应的目标代码块。如果有，直接跳至其目标代码的入口地址执行；如果没有，跳至(5)。

(5) 动态二进制的翻译模块将给定的源机器指令翻译成中间指令形式的一个基本块，并做适当优化，并翻译成目标机器代码形式的目标代码块，并存至目标代码缓存中。

(6) 执行目标代码基本块，得到下一条的源机器指令地址，跳至(1)。

### 2. 思考

2.1. 考虑这样一种情况，如果程序所需的库函数在本地没有怎么办？所以动态二进制翻译的库函数问题最重要的还是解决库的移植问题。