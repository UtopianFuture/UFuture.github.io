## 动态二进制翻译后端代码热路径的重组优化

### 1. 一些背景知识

（1）Profiling 是指对程序运行时信息的统计和收集。

（2）热路径是指程序中频繁执行的代码块序列，它们可以集中地反映程序动态执行的特征轨迹，具有很好的代码局部特性和顺序特性。热路径需要通过一定的预测算法来识别。

（3）超级块是指将热路径上的基本块合并成具有单一入口和多个出口的指令序列。热路径的构造实际操作来说就是超级块的构造。超级块可以减少因基本块的结束而带来的上下文切换，也可以更好的优化代码。超级块的长度越长越好，而数量越少越好。

（4）动静结合的动态二进制翻译器是指运行完程序一次记录下来程序的运行信息，然后离线的对内存布局进行整理优化，再重新加载到内存中运行优化后的代码。

### 2. 动态热路径构造

用profiling获取程序的执行信息（重复次数），通过这些数据作出预测，分析出热路径，然后将路径上的基本块合成超级块。超级块在物理代码上往往是连续的，这样的代码布局(Code Layout)有利于提高指令Cache 和分支预测(Branch Prediction)的命中率，另外由于控制结构比较简单，在路径上可以方便的快速高效的实施优化。

#### 2.1. 热路径优化的流程

- Profiling：翻译过的目标代码中采用插桩(instrumentation)方式，插入 profiling代码 。Profiling 主要负责更新基本块执行频度并触发下一步构造超级块的操作。
- 识别热路径：代码块的执行频度反映了代码执行的热度，随着程序的执行，基本块的热度是不断增加的；当热度大于某个预设临界值后，该基本块则被记为路径头，然后触发热路径识别算法，识别该路径的其他基本块。
- 生成超级块：生成超级块是基于识别出的热路径。
- 分析并优化超级块。
- 生成目标代码（该算法是基于中间代码设计的，但这种思想也可以用来点对点的二进制翻译中）。

### 3. 动静结合框架

动静结合框架第一次动态执行收集丰富 profiling 信息的过程，其性能是比较低的。然后它将收集到的 profiling 信息离线的保存到硬盘的文件中，同时保存的还有翻译后的后端代码。翻译器利用收集的信息，对翻译后的代码进行离线的重组优化等操作，之后重新加载到内存中，之后再执行这部分代码就可运行优化后的后端代码，运行的性能就明显的优于一般的动态优化框架。这样就既可以获取丰富的 profiling 信息，又可以对性能获取比较大的提升，但程序性能提升的效果必须是多次执行后才能体现出来的。

![img](file:///tmp/lu3432230owno09.tmp/lu3432230owno11_tmp_19013b32a6cdfb82.png)  


### 四、思考

\1. xqm中不知道有没有用到超级块的概念，看看tb-link这个优化项和超级块之间有什么相似处。

\2. 详细了解一下上下文切换，即翻译环境和执行环境的切换，看xqm是怎么实现的。