## bmbt系统级虚拟化

### 零、虚拟化知识

VMM对物理资源的虚拟可以归结为三个主要任务：处理器虚拟化、内存虚拟化和I/O虚拟化。

#### 1. 可虚拟化架构与不可虚拟化架构

系统级的虚拟机由于VMM直接运行在bare metal上，整体可以分为3个部分：

![image-20211007102918303](/home/guanshun/.config/Typora/typora-user-images/image-20211007102918303.png)

在我们的项目中，虚拟机暂时是ubuntu，虚拟机监控器是bmbt，硬件是LoongArch。

敏感指令：操作特权资源的指令，包括修改虚拟机的运行模式或物理机的状态，访存等等。所有的特权指令都是敏感指令，但不是所有的敏感指令都是特权指令。为了VMM能够完全控制物理资源，敏感指令必须在VMM的监督下才能运行，或者经由VMM完成。如果一个系统所有的敏感指令都是特权指令，那么只需要将VMM运行在系统的最高特权级上，而guest系统运行在非最高特权级上，在执行敏感指令时，陷入到VMM中。而如果像x86架构一样，不是所有的敏感指令都是特权指令，那么我们就说这种架构存在虚拟化漏洞，是不可虚拟化架构。这种架构需要采用一些辅助方法，如在硬件层面填补虚拟化漏洞——VT；通过软件方法避免使用无法陷入的敏感指令。

问题：BMBT要怎样解决x86的虚拟化漏洞？

#### 2. 处理器虚拟化

##### 2.1 指令模拟

​	guest运行的架构可能不是原架构，如ubuntu只能运行在x86架构上，如何使其在LoongArch架构的CPU上运行却察觉不到和x86架构有区别，换句话说，其运行的处理器和VMM需要提供与其“期望”的处理器一致的功能和行为。典型的“期望”包括：

（1）指令集和与执行效果。

（2）可用寄存器集合，包括通用寄存器以及各种系统寄存器。

（3）运行模式，如实模式、保护模式和64位长模式等。处理器的运行模式决定了指令执行的效果、寻址宽度与限制以及保护粒度等。

（4）地址翻译系统，如页表级数。

（5）保护机制，如分段和分页等。

（6）中断/异常机制，如虚拟处理器必须能够正确模拟真实处理器的行为，在错误的执行条件下，为虚拟机注入一个虚拟的异常。

##### 2.2 中断和异常的模拟及注入

​	VMM对于异常的虚拟化需要完全按照物理处理器对于各种异常条件的定义，再根据虚拟处理器当时的内容，来判断是否需要模拟出一个虚拟的异常，并注入到guest中。

##### 2.3 SMP模拟

​	底层有N个物理CPU，能够虚拟出M个虚拟CPU。

问题：

1. bmbt如何达到这一功能，即让ubuntu运行在LoongArch架构的CPU上运行却察觉不到和x86架构有区别？仿照QEMU？
2. 如何解决虚拟寄存器，上下文切换和虚拟处理器？之前看《LINUX系统虚拟化》了解到，虚拟CPU就是定义一个结构体来表示，如KVM中的VMCS，QEMU中的X86State等，之后所有的操作都是对这个结构体进行操作，bmbt也是这样实现的么？
3. 当guest要访问敏感资源时，要陷入到VMM，如何陷入？
4. 二进制翻译是用latx还是用QEMU的tcg？

#### 3. 内存虚拟化(见[linux系统虚拟化](https://github.com/UtopianFuture/UtopianFuture.github.io/blob/master/linux-note/linux%E7%B3%BB%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%8C%96.md))

问题：

（1）内存分配算法怎样设计？

#### 4. I/O虚拟化(见[linux系统虚拟化](https://github.com/UtopianFuture/UtopianFuture.github.io/blob/master/linux-note/linux%E7%B3%BB%E7%BB%9F%E8%99%9A%E6%8B%9F%E5%8C%96.md))

​	现实中I/O资源是有限的额，为了满足多个gues对I/O的访问需求，VMM必须通过I/O虚拟化的方式复用有限的I/O资源。

问题：

（1）I/O虚拟化的设计思想是什么？目前进展怎么样？

